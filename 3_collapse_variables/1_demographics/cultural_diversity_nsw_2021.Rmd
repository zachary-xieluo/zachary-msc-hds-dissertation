
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(forcats)
library(scales)
```

```{r, include=FALSE}
# Read datasets (variables from prepossessing folder)
pop_nsw_2021 <- read.csv("pop_size_nsw_2021.csv")
cob_nsw_2021 <- read.csv("cob_nsw_2021.csv") %>%
  rename(sa2_name_2021 = sa2)
lang_nsw_2021 <- read.csv("lagge_spk_nsw_2021.csv") %>%
  rename(sa2_name_2021 = sa2)
ance1st_nsw_2021 <- read.csv("ancestry_1st_resp_nsw_2021.csv") %>%
  rename(sa2_name_2021 = sa2)
sa2_lga_lhd_nsw_2021 <- read.csv("sa2_lga_lhd_nsw_2021.csv")
```

```{r}
names(cob_nsw_2021)
names(lang_nsw_2021)
names(ance1st_nsw_2021)
```


```{r}
# Clean cob dataset
cob_nsw_2021 <- cob_nsw_2021 %>%
  rename_with(~ tolower(.x)  %>%
    str_replace_all("[._/]+", "_")  %>%
    str_replace_all("^_+|_+$", "")) %>%
  rename(australia = australia_includes_external_territories,
         sup_codes_cob = supplementary_codes,
         not_stated_cob = not_stated)

# Exclude numerical columns (not included in overseas summation)
overseas_prot_cols <- c("australia", 
                        "overseas", 
                        "sup_codes_cob", 
                        "not_stated_cob")

overseas_cols <- cob_nsw_2021 %>%
  select(where(is.numeric)) %>%
  names() %>%
  setdiff(overseas_prot_cols)

cob_nsw_2021 <- cob_nsw_2021 %>%
  mutate(overseas = rowSums(across(all_of(overseas_cols)), na.rm = TRUE))
```


```{r}
# Clean lang dataset
lang_nsw_2021 <- lang_nsw_2021 %>%
  rename_with(~ tolower(.x)  %>%
    str_replace_all("[._/]+", "_")  %>%
    str_replace_all("^_+|_+$", "")) %>%
    rename(sup_codes_lang = supplementary_codes,
           not_stated_lang = not_stated)
  
# Exclude numerical columns (not included in non-english summation)
lang_prot_cols <- c("english", 
                    "non_english", 
                    "sup_codes_lang", 
                    "not_stated_lang")

non_english_cols <- lang_nsw_2021 %>%
  select(where(is.numeric)) %>%
  names() %>%
  setdiff(lang_prot_cols)

lang_nsw_2021 <- lang_nsw_2021 %>%
  mutate(non_english = rowSums(across(all_of(non_english_cols)), na.rm = TRUE))
```

```{r}
# Clean ance1st dataset
ance1st_nsw_2021 <- ance1st_nsw_2021 %>%
  rename_with(~ tolower(.x)  %>%
    str_replace_all("[._/]+", "_")  %>%
    str_replace_all("^_+|_+$", "")) %>%
    rename(not_stated_ance1st = not_stated)

ance1st_prot_cols <- c("australian_peoples", 
                    "non_australian", 
                    "inadequately_described",
                    "so_described_nfd",
                    "not_stated_ance1st")

# Exclude numerical columns (not included in non-australian summation)
non_australian_cols <- ance1st_nsw_2021 %>%
  select(where(is.numeric)) %>%
  names() %>%
  setdiff(ance1st_prot_cols)

ance1st_nsw_2021 <- ance1st_nsw_2021 %>%
  mutate(non_australian = rowSums(across(all_of(non_australian_cols)), na.rm = TRUE))
```

```{r}
cd_nsw_2021 <- pop_nsw_2021 %>%
  left_join(cob_nsw_2021, by = "sa2_name_2021") %>%
  left_join(lang_nsw_2021, by = "sa2_name_2021") %>%
  left_join(ance1st_nsw_2021, by = "sa2_name_2021") %>%
  left_join(sa2_lga_lhd_nsw_2021, by = "sa2_name_2021")
```


```{r}
cob_aus_osea_wslhd_2021 <- cd_nsw_2021 %>%
  filter(in_wslhd == 1) %>%
  filter(lga_name_2021 %in% c("Blacktown", "Cumberland", "Parramatta", "The Hills Shire")) %>%
  select(sa2_name_2021, lga_name_2021, pop_size, australia, overseas, not_stated_cob)

cob_lga_wslhd <- cob_aus_osea_wslhd_2021 %>%
  group_by(lga_name_2021) %>%
  summarise(
    pop_total = sum(pop_size, na.rm = TRUE),
    australia = sum(australia, na.rm = TRUE),
    overseas  = sum(overseas,  na.rm = TRUE),
    not_stated_cob  = sum(not_stated_cob,  na.rm = TRUE),
    .groups = "drop"
  )

cob_lga_wslhd_long <- cob_lga_wslhd %>%
  pivot_longer(
    cols = c(australia, overseas, not_stated_cob),
    names_to = "origin",
    values_to = "count"
  ) %>%
  mutate(
    origin = factor(origin, levels = c("australia", "overseas", "not_stated_cob"),
                    labels = c("Australia", "Overseas", "Not Stated")),
    prop = count / pop_total
  )

cob_lga_wslhd_order <- cob_lga_wslhd_long %>%
  filter(origin == "Overseas") %>%
  arrange(desc(prop)) %>%
  pull(lga_name_2021)

cob_lga_wslhd_long <- cob_lga_wslhd_long %>%
  mutate(lga_name_2021 = factor(lga_name_2021, levels = cob_lga_wslhd_order))
```

```{r}
cob_lga_wslhd_lab <- cob_lga_wslhd_long %>%
  mutate(
    prop  = count / pop_total,
    label = 
      paste0(comma(count), "\n", percent(prop, accuracy = 0.1)))

ggplot(cob_lga_wslhd_lab, aes(x = lga_name_2021, y = prop, fill = origin)) +
  geom_col(width = 0.5) +
  geom_text(aes(label = label),
            position = position_stack(vjust = 0.5),
            size = 3, lineheight = 0.9, color = "black") +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  scale_fill_manual(values = c("Australia"  = "#F8766D",
                               "Overseas"   = "#00BFC4",
                               "Not Stated" = "grey70")) +
  labs(x = NULL, y = "Proportion",
       fill = NULL,
       title = "Australia vs Overseas — Proportion by LGA (WSLHD, 2021)") +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(),
        legend.position = "bottom")
```

```{r}
cob_wslhd_2021 <- cd_nsw_2021 %>%
  filter(in_wslhd == 1)
  
overseas_tot <- cob_wslhd_2021 %>%
  summarise(
    across(all_of(overseas_cols), ~ sum(.x, na.rm = TRUE)),
    pop_total = sum(pop_size, na.rm = TRUE) 
  ) %>%
  pivot_longer(
    cols = all_of(overseas_cols),         
    names_to = "country",
    values_to = "count"
  ) %>%
  mutate(
    prop = count / pop_total,            
    country_label = country %>% str_replace_all("_", " ") %>% str_to_title()
  ) %>%
  select(-pop_total) 

```

```{r}
overseas_tot <- overseas_tot %>% 
  slice_max(order_by = count, n = 10, with_ties = FALSE)

ggplot(overseas_tot, aes(x = reorder(country_label, count), y = count)) +
  geom_col(width = 0.7) +
  geom_text(aes(label = paste0(comma(count), " (", percent(prop, accuracy = 0.1), ")")),
            hjust = -0.05, size = 2) +
  coord_flip() +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.12))) +
  labs(x = NULL, y = "Count",
       title = "WSLHD — Overseas Country of Birth (Top 10)") +
  theme_minimal(base_size = 12)
```

```{r}
lang_eng_wslhd_2021 <- cd_nsw_2021 %>%
  filter(in_wslhd == 1) %>%
  filter(lga_name_2021 %in% c("Blacktown", "Cumberland", "Parramatta", "The Hills Shire")) %>%
  select(sa2_name_2021, lga_name_2021, pop_size, english, non_english, not_stated_lang)

lang_lga_wslhd <- lang_eng_wslhd_2021 %>%
  group_by(lga_name_2021) %>%
  summarise(
    pop_total = sum(pop_size, na.rm = TRUE),
    english = sum(english, na.rm = TRUE),
    non_english  = sum(non_english,  na.rm = TRUE),
    not_stated_lang  = sum(not_stated_lang,  na.rm = TRUE),
    .groups = "drop"
  )

lang_lga_wslhd_long <- lang_lga_wslhd %>%
  pivot_longer(
    cols = c(english, non_english, not_stated_lang),
    names_to = "origin",
    values_to = "count"
  ) %>%
  mutate(
    origin = factor(origin, levels = c("english", "non_english","not_stated_lang"),
                    labels = c("English", "Non-English", "Not Stated")),
    prop = count / pop_total
  )

lang_lga_wslhd_order <- lang_lga_wslhd_long %>%
  filter(origin == "Non-English") %>%
  arrange(desc(prop)) %>%
  pull(lga_name_2021)

lang_lga_wslhd_long <- lang_lga_wslhd_long %>%
  mutate(lga_name_2021 = factor(lga_name_2021, levels = lang_lga_wslhd_order))
```

```{r}
lang_lga_wslhd_lab <- lang_lga_wslhd_long %>%
  mutate(
    prop  = count / pop_total,
    label = 
      paste0(comma(count), "\n", percent(prop, accuracy = 0.1)))

ggplot(lang_lga_wslhd_lab, aes(x = lga_name_2021, y = prop, fill = origin)) +
  geom_col(width = 0.5) +
  geom_text(aes(label = label),
            position = position_stack(vjust = 0.5),
            size = 3, lineheight = 0.9, color = "black") +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  scale_fill_manual(values = c("English"  = "#F8766D",
                               "Non-English"   = "#00BFC4",
                               "Not Stated" = "grey70")) +
  labs(x = NULL, y = "Proportion",
       fill = NULL,
       title = "English vs Non-English Speaking at Home — Proportion by LGA (WSLHD, 2021)") +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(),
        legend.position = "bottom")
```

```{r}
lang_wslhd_2021 <- cd_nsw_2021 %>%
  filter(in_wslhd == 1)
  
non_english_tot <- lang_wslhd_2021 %>%
  summarise(
    across(all_of(non_english_cols), ~ sum(.x, na.rm = TRUE)),
    pop_total = sum(pop_size, na.rm = TRUE) 
  ) %>%
  pivot_longer(
    cols = all_of(non_english_cols),         
    names_to = "language",
    values_to = "count"
  ) %>%
  mutate(
    prop = count / pop_total,            
    language_label = language %>% str_replace_all("_", " ") %>% str_to_title()
  ) %>%
  select(-pop_total) 

```

```{r}
non_english_tot <- non_english_tot %>% 
  slice_max(order_by = count, n = 10, with_ties = FALSE)

ggplot(non_english_tot, aes(x = reorder(language_label, count), y = count)) +
  geom_col(width = 0.7) +
  geom_text(aes(label = paste0(comma(count), " (", percent(prop, accuracy = 0.1), ")")),
            hjust = -0.05, size = 2) +
  coord_flip() +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.12))) +
  labs(x = NULL, y = "Count",
       title = "WSLHD — Non-English Speaking at Home (Top 10)") +
  theme_minimal(base_size = 12)
```

```{r}
ance1st_wslhd_2021 <- cd_nsw_2021 %>%
  filter(in_wslhd == 1) %>%
  filter(lga_name_2021 %in% c("Blacktown", "Cumberland", "Parramatta", "The Hills Shire")) %>%
  select(sa2_name_2021, lga_name_2021, pop_size, australian_peoples, non_australian,
         not_stated_ance1st)

ance1st_lga_wslhd <- ance1st_wslhd_2021 %>%
  group_by(lga_name_2021) %>%
  summarise(
    pop_total = sum(pop_size, na.rm = TRUE),
    australian_peoples = sum(australian_peoples, na.rm = TRUE),
    non_australian  = sum(non_australian,  na.rm = TRUE),
    not_stated_ance1st  = sum(not_stated_ance1st,  na.rm = TRUE),
    .groups = "drop"
  )

ance1st_lga_wslhd_long <- ance1st_lga_wslhd %>%
  pivot_longer(
    cols = c(australian_peoples, non_australian, not_stated_ance1st),
    names_to = "origin",
    values_to = "count"
  ) %>%
  mutate(
    origin = factor(origin, levels = c("australian_peoples", "non_australian", 
                                       "not_stated_ance1st"),
                    labels = c("Australian", "Non-Australian", "Not Stated")),
    prop = count / pop_total
  )

ance1st_lga_wslhd_order <- ance1st_lga_wslhd_long %>%
  filter(origin == "Non-Australian") %>%
  arrange(desc(prop)) %>%
  pull(lga_name_2021)

ance1st_lga_wslhd_long <- ance1st_lga_wslhd_long %>%
  mutate(lga_name_2021 = factor(lga_name_2021, levels = ance1st_lga_wslhd_order))
```

```{r}
ance1st_lga_wslhd_lab <- ance1st_lga_wslhd_long %>%
  mutate(
    prop  = count / pop_total,
    label = 
      paste0(comma(count), "\n", percent(prop, accuracy = 0.1)),
      NA_character_
    )

ggplot(ance1st_lga_wslhd_lab, aes(x = lga_name_2021, y = prop, fill = origin)) +
  geom_col(width = 0.5) +
  geom_text(aes(label = label),
            position = position_stack(vjust = 0.5),
            size = 3, lineheight = 0.9, color = "black") +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  scale_fill_manual(values = c("Australian"  = "#F8766D",
                               "Non-Australian" = "#00BFC4",
                               "Not Stated" = "grey70")) +
  labs(x = NULL, y = "Proportion",
       fill = NULL,
       title = "Australian vs Non-Australian — Proportion by LGA (WSLHD, 2021)") +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(),
        legend.position = "bottom")
```

```{r}
ance1st_wslhd_2021 <- cd_nsw_2021 %>%
  filter(in_wslhd == 1)
  
non_australian_tot <- ance1st_wslhd_2021 %>%
  summarise(
    across(all_of(non_australian_cols), ~ sum(.x, na.rm = TRUE)),
    pop_total = sum(pop_size, na.rm = TRUE) 
  ) %>%
  pivot_longer(
    cols = all_of(non_australian_cols),         
    names_to = "ancestry",
    values_to = "count"
  ) %>%
  mutate(
    prop = count / pop_total,            
    ancestry_label = ancestry %>% str_replace_all("_", " ") %>% str_to_title()
  ) %>%
  select(-pop_total) 

```

```{r}
non_australian_tot <- non_australian_tot %>% 
  slice_max(order_by = count, n = 10, with_ties = FALSE)

ggplot(non_australian_tot, aes(x = reorder(ancestry_label, count), y = count)) +
  geom_col(width = 0.7) +
  geom_text(aes(label = paste0(comma(count), " (", percent(prop, accuracy = 0.1), ")")),
            hjust = -0.05, size = 2) +
  coord_flip() +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.12))) +
  labs(x = NULL, y = "Count",
       title = "WSLHD — Ancestry 1st Responce (Top 10)") +
  theme_minimal(base_size = 12)
```
