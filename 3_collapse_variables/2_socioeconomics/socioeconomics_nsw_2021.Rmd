
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(readr)
library(dplyr)
library(tidyr)
```


```{r, include=FALSE}
# Read datasets (variables from prepossessing folder)
pop_nsw_2021 <- read.csv("pop_size_nsw_2021.csv")
edu_nsw_2021 <- read.csv("edu_level_nsw_2021.csv")
occup_nsw_2021 <- read.csv("occupation_nsw_2021.csv")
hohd_compo_nsw_2021 <- read.csv("hohd_compo_nsw_2021.csv")
hohd_income_nsw_2021 <- read.csv("hohd_income_nsw_2021.csv")
labr_stats_nsw_2021 <- read.csv("labr_stats_nsw_2021.csv")
sa2_wslhd_2021 <- read.csv("wslhd_sa2_2021.csv")
```

```{r}
# Read column names
names(edu_nsw_2021)
names(occup_nsw_2021)
names(hohd_compo_nsw_2021)
names(hohd_income_nsw_2021)
names(labr_stats_nsw_2021)
```

```{r}
# Unify format
edu_nsw_2021 <- edu_nsw_2021 %>%
  rename(
    sa2 = sa2,
    postgrad = `Postgraduate.Degree.Level`,
    grad_dip_cert = `Graduate.Diploma.and.Graduate.Certificate.Level`,
    bachelor = `Bachelor.Degree.Level`,
    adv_diploma = `Advanced.Diploma.and.Diploma.Level`,
    cert_iii_iv = `Certificate.III...IV.Level`,
    sec_10_plus = `Secondary.Education...Years.10.and.above`,
    cert_i_ii = `Certificate.I...II.Level`,
    sec_below_10 = `Secondary.Education...Years.9.and.below`,
    supp_codes_edu = `Supplementary.Codes`,
    not_stated_edu = `Not.stated`,
    not_applicable_edu = `Not.applicable`
  )

occup_nsw_2021 <- occup_nsw_2021 %>%
  rename(
    sa2 = sa2,
    managers = Managers,
    professionals = Professionals,
    tech_trades = `Technicians.and.Trades.Workers`,
    comm_personal = `Community.and.Personal.Service.Workers`,
    clerical_admin = `Clerical.and.Administrative.Workers`,
    sales = `Sales.Workers`,
    machinery_ops = `Machinery.Operators.and.Drivers`,
    labourers = Labourers,
    inadequate_occup = `Inadequately.described`,
    not_stated_occup = `Not.stated`,
    not_applicable_occup = `Not.applicable`
  )

hohd_compo_nsw_2021 <- hohd_compo_nsw_2021 %>%
  rename(
    sa2 = sa2,
    one_family = One.family.household,
    multi_family = Multiple.family.household,
    non_family = Non.family.household,
    non_classifiable_hohd_compo = Non.classifiable,
    not_applicable_hohd_compo = Not.applicable
  )

hohd_income_nsw_2021 <- hohd_income_nsw_2021 %>%
  rename(
    sa2 = sa2,
    neg_income = Negative.income,
    nil_income = Nil.income,
    `1_149` = X.1..149...1..7.799.,
    `150_299` = X.150..299...7.800..15.599.,
    `300_399` = X.300..399...15.600..20.799.,
    `400_499` = X.400..499...20.800..25.999.,
    `500_649` = X.500..649...26.000..33.799.,
    `650_799` = X.650..799...33.800..41.599.,
    `800_999` = X.800..999...41.600..51.999.,
    `1000_1249` = X.1.000..1.249...52.000..64.999.,
    `1250_1499` = X.1.250..1.499...65.000..77.999.,
    `1500_1749` = X.1.500..1.749...78.000..90.999.,
    `1750_1999` = X.1.750..1.999...91.000..103.999.,
    `2000_2499` = X.2.000..2.499...104.000..129.999.,
    `2500_2999` = X.2.500..2.999...130.000..155.999.,
    `3000_3499` = X.3.000..3.499...156.000..181.999.,
    `3500_3999` = X.3.500..3.999...182.000..207.999.,
    `4000_4499` = X.4.000..4.499...208.000..233.999.,
    `4500_4999` = X.4.500..4.999...234.000..259.999.,
    `5000_5999` = X.5.000..5.999...260.000..311.999.,
    `6000_7999` = X.6.000..7.999...312.000..415.999.,
    `8000_plus` = X.8.000.or.more...416.000.or.more.,
    partial_stated = Partial.income.stated,
    not_stated_hohd_income = All.incomes.not.stated,
    not_applicable_hohd_income = Not.applicable
  )

labr_stats_nsw_2021 <- labr_stats_nsw_2021 %>%
  rename(
    sa2 = sa2,
    employed_fulltime = Employed..worked.full.time,
    employed_parttime = Employed..worked.part.time,
    employed_away = Employed..away.from.work,
    unemployed_fulltime = Unemployed..looking.for.full.time.work,
    unemployed_parttime = Unemployed..looking.for.part.time.work,
    not_in_labour_force = Not.in.the.labour.force,
    not_stated_labr_stats = Not.stated,
    not_applicable_labr_stats = Not.applicable
  )

```

```{r}
# Join variables into pop_nsw datasets
pop_nsw_2021 <- pop_nsw_2021 %>%
  rename(sa2 = "sa2_name_2021") %>%
  left_join(edu_nsw_2021, by = "sa2") %>%
  left_join(occup_nsw_2021, by = "sa2") %>%
  left_join(hohd_compo_nsw_2021, by = "sa2") %>%
  left_join(hohd_income_nsw_2021, by = "sa2") %>%
  left_join(labr_stats_nsw_2021, by = "sa2")
```

```{r}
socioeconomics_nsw_2021 <- pop_nsw_2021 %>%
  mutate(
    # Collapse edu_level
    bachelor_above = rowSums(across(c(postgrad, grad_dip_cert, bachelor)), na.rm = TRUE),
    high_school_below = rowSums(across(c(cert_iii_iv, sec_10_plus, cert_i_ii, sec_below_10)), na.rm = TRUE),
    
    # Collapse occupation
    managers_professionals = rowSums(across(c(managers, professionals)), na.rm = TRUE),
    everyone_else = rowSums(across(c(tech_trades, comm_personal, clerical_admin, sales, machinery_ops, labourers)), na.rm = TRUE),
 
    # Collapse household income
    neg_nil_income = rowSums(across(c(neg_income, nil_income)), na.rm = TRUE),
    very_low_income = rowSums(across(c(`1_149`, `150_299`, `300_399`, `400_499`, `500_649`, `650_799`, `800_999`)), na.rm = TRUE),
    low_income = rowSums(across(c(`1000_1249`, `1250_1499`)), na.rm = TRUE),
    middle_income = rowSums(across(c(`1500_1749`, `1750_1999`, `2000_2499`)), na.rm = TRUE),
    high_income = rowSums(across(c(`2500_2999`)), na.rm = TRUE),
    very_high_income = rowSums(across(c(`3000_3499`, `3500_3999`, `4000_4499`, `4500_4999`, `5000_5999`, `6000_7999`, `8000_plus`)), na.rm = TRUE),
 
    # Collapse labour status
    employed = rowSums(across(c(employed_fulltime, employed_parttime, employed_away)), na.rm = TRUE),
    unemployed = rowSums(across(c(unemployed_fulltime, unemployed_parttime)), na.rm = TRUE)
  )
```

```{r}
socioeconomics_nsw_2021 <- socioeconomics_nsw_2021 %>%
  mutate(
    # Adjust denominators
    denominator_edu = pop_size - not_applicable_edu,
    denominator_occup = pop_size - not_applicable_occup,
    denominator_hohd_compo = pop_size - not_applicable_hohd_compo,
    denominator_hohd_income = pop_size - not_applicable_hohd_income,
    denominator_labr_stats = pop_size - not_applicable_labr_stats,
    
    # Calculate proportions (education level)
    prop_bachelor_above = if_else(denominator_edu > 0, bachelor_above / denominator_edu, NA_real_),
    prop_adv_diploma = if_else(denominator_edu > 0, adv_diploma / denominator_edu, NA_real_),
    prop_high_school_below = if_else(denominator_edu > 0, high_school_below / denominator_edu, NA_real_),
    
    # Calculate proportions (occupation)
    prop_managers_professionals = if_else(denominator_occup > 0, managers_professionals / denominator_occup, NA_real_),
    prop_everyone_else = if_else(denominator_occup > 0, everyone_else / denominator_occup, NA_real_),
    
    # Calculate proportions (household composition)
    prop_one_family = if_else(denominator_hohd_compo > 0, one_family / denominator_hohd_compo, NA_real_),
    prop_multi_family = if_else(denominator_hohd_compo > 0, multi_family / denominator_hohd_compo, NA_real_),
    prop_non_family = if_else(denominator_hohd_compo > 0, non_family / denominator_hohd_compo, NA_real_),
    
    # Calculate proportions (household income)
    prop_neg_nil_income = if_else(denominator_hohd_income > 0, neg_nil_income / denominator_hohd_income, NA_real_),
    prop_very_low_income = if_else(denominator_hohd_income > 0, very_low_income / denominator_hohd_income, NA_real_),
    prop_low_income = if_else(denominator_hohd_income > 0, low_income / denominator_hohd_income, NA_real_),
    prop_middle_income = if_else(denominator_hohd_income > 0, middle_income / denominator_hohd_income, NA_real_),
    prop_high_income = if_else(denominator_hohd_income > 0, high_income / denominator_hohd_income, NA_real_),
    prop_very_high_income = if_else(denominator_hohd_income > 0, very_high_income / denominator_hohd_income, NA_real_),
    
    # Calculate proportions (labor status)
    prop_employed = if_else(denominator_labr_stats > 0, employed / denominator_labr_stats, NA_real_),
    prop_unemployed = if_else(denominator_labr_stats > 0, unemployed / denominator_labr_stats, NA_real_),
    prop_not_in_labour_force = if_else(denominator_labr_stats > 0, not_in_labour_force / denominator_labr_stats, NA_real_)
  )
```

```{r}
# Retain key variables
socioeconomics_nsw_2021 <- socioeconomics_nsw_2021 %>%
  select(
    sa2, in_wslhd, in_metro, pop_size,
    
    # Education level
    bachelor_above, adv_diploma, high_school_below,
    
    # Occupation
    managers_professionals, everyone_else,
    
    # Household composition
    
    one_family, multi_family, non_family,
    
    # Household income
    neg_nil_income, very_low_income, 
    low_income, middle_income, 
    high_income, very_high_income,
    
    # Labor force status
    employed, unemployed, not_in_labour_force,
    
    # Proportions
    prop_bachelor_above, 
    prop_adv_diploma, 
    prop_high_school_below,
    prop_managers_professionals, 
    prop_everyone_else,
    prop_one_family, 
    prop_multi_family, 
    prop_non_family,
    prop_neg_nil_income, 
    prop_very_low_income, 
    prop_low_income, 
    prop_middle_income,
    prop_high_income, 
    prop_very_high_income,
    prop_employed, 
    prop_unemployed, 
    prop_not_in_labour_force
  ) %>%
  
  rename(sa2_name_2021 = "sa2")

# write_csv(socioeconomics_nsw_2021, "socioeconomics_nsw_2021.csv")
```

