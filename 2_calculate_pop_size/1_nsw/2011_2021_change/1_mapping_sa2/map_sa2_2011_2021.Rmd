```{r}
library(dplyr)
library(readr)
library(tidyr)
library(stringr)
library(scales)
```

```{r}

# ---- 1) Load ABS correspondence tables (keep original column names)
corr_11_16 <- readr::read_csv("CG_SA2_2011_SA2_2016.csv")
corr_16_21 <- readr::read_csv("CG_SA2_2016_SA2_2021.csv")

# ---- 2) Standardise columns & choose weights
# 2011->2016: prefer RATIO, else fall back to PERCENTAGE/100
# 2016->2021: use RATIO_FROM_TO

c11_16 <- corr_11_16 %>%
  transmute(
    sa2_code_2011 = SA2_MAINCODE_2011,
    sa2_name_2011 = str_squish(SA2_NAME_2011),
    sa2_code_2016 = SA2_MAINCODE_2016,
    sa2_name_2016 = str_squish(SA2_NAME_2016),
    w_11_16 = ifelse(!is.na(RATIO), RATIO, PERCENTAGE / 100)
  ) %>%
  mutate(w_11_16 = pmin(pmax(w_11_16, 0), 1))


c16_21 <- corr_16_21 %>%
  transmute(
    sa2_code_2016 = SA2_MAINCODE_2016,
    sa2_name_2016 = str_squish(SA2_NAME_2016),
    sa2_code_2021 = SA2_CODE_2021,
    sa2_name_2021 = str_squish(SA2_NAME_2021),
    w_16_21 = RATIO_FROM_TO
  ) %>%
  mutate(w_16_21 = pmin(pmax(w_16_21, 0), 1))

# ---- 3) Chain 2011->2021; keep raw weights; compute both normalisations
# - weight_norm_to_2021: p(2011 | 2021)   -> sources of a 2021 SA2
# - weight_norm_from_2011: p(2021 | 2011) -> splits of a 2011 SA2

c11_21_weighted <- c11_16 %>%
  inner_join(c16_21, by = "sa2_code_2016") %>%
  mutate(w_11_21 = w_11_16 * w_16_21) %>%
  group_by(sa2_code_2011, sa2_name_2011, sa2_code_2021, sa2_name_2021) %>%
  summarise(weight_raw = sum(w_11_21, na.rm = TRUE), .groups = "drop") %>%
  group_by(sa2_code_2021, sa2_name_2021) %>%
  mutate(weight_norm_to_2021 = weight_raw / sum(weight_raw, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(sa2_code_2011, sa2_name_2011) %>%
  mutate(weight_norm_from_2011 = weight_raw / sum(weight_raw, na.rm = TRUE)) %>%
  ungroup()

# ---- 4) Load your NSW-wide SA2 list (2021) using your naming
# Expecting columns: sa2_code_2021, sa2_name_2021 (plus LGA/LHD attrs)
sa2_lga_lhd_nsw_2021 <- readr::read_csv("sa2_lga_lhd_nsw_2021.csv", show_col_types = FALSE) %>%
  mutate(
    sa2_code_2021 = as.character(sa2_code_2021),
    sa2_name_2021 = str_squish(as.character(sa2_name_2021))
  )

# One-row-per-SA2 lookup (keeps ALL original columns)
map_lookup <- sa2_lga_lhd_nsw_2021 %>%
  distinct(sa2_code_2021, .keep_all = TRUE)

# Minimal NSW list for joins (safe to join by code; keep name for readability)
nsw_sa2_2021 <- map_lookup %>%
  distinct(sa2_code_2021, sa2_name_2021)

# Columns from the mapping table to append at the END of outputs
extra_cols <- setdiff(names(map_lookup), c("sa2_code_2021", "sa2_name_2021"))

# ---- 5) Filter correspondences to NSW only by 2021 SA2 membership
map_nsw_all <- c11_21_weighted %>%
  semi_join(nsw_sa2_2021, by = "sa2_code_2021")

# ---- A) 2021-side view: which 2011 SA2s contribute to each 2021 SA2?
nsw_list_to_2021_core <- map_nsw_all %>%
  arrange(sa2_name_2021, desc(weight_norm_to_2021)) %>%
  transmute(
    sa2_code_2021, sa2_name_2021,
    sa2_code_2011, sa2_name_2011,
    weight_norm_to_2021,
    weight_percent_to_2021 = scales::percent(weight_norm_to_2021, accuracy = 0.1)
  )

# Append ALL original mapping columns at the END
nsw_map_list_to_2021 <- nsw_list_to_2021_core %>%
  left_join(map_lookup %>% select(sa2_code_2021, dplyr::all_of(extra_cols)),
            by = "sa2_code_2021") %>%
  select(everything(), dplyr::all_of(extra_cols))

# ---- B) 2011-side view: how each 2011 SA2 splits across 2021 SA2s?
nsw_map_list_from_2011_core <- map_nsw_all %>%
  arrange(sa2_name_2011, desc(weight_norm_from_2011)) %>%
  transmute(
    sa2_code_2011, sa2_name_2011,
    sa2_code_2021, sa2_name_2021,
    weight_norm_from_2011,
    weight_percent_from_2011 = scales::percent(weight_norm_from_2011, accuracy = 0.1)
  )

# Append ALL original mapping columns at the END
nsw_map_list_from_2011 <- nsw_map_list_from_2011_core %>%
  left_join(map_lookup %>% select(sa2_code_2021, dplyr::all_of(extra_cols)),
            by = "sa2_code_2021") %>%
  select(everything(), dplyr::all_of(extra_cols))

# ---- C) Optional: one-to-one “main match” (largest share only)
# For each 2021 SA2: pick its largest 2011 contributor
nsw_main_to_2021 <- map_nsw_all %>%
  group_by(sa2_code_2021, sa2_name_2021) %>%
  slice_max(weight_norm_to_2021, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  select(sa2_code_2021, sa2_name_2021, sa2_code_2011, sa2_name_2011)

nsw_main_from_2011 <- map_nsw_all %>%
  group_by(sa2_code_2011, sa2_name_2011) %>%
  slice_max(weight_norm_from_2011, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  select(sa2_code_2011, sa2_name_2011, sa2_code_2021, sa2_name_2021)

# ---- D) Optional: attach main 2011 match back to the NSW 2021 list
nsw_2021_to_2011 <- nsw_sa2_2021 %>%
  left_join(nsw_main_to_2021 %>% select(sa2_code_2021, sa2_name_2011),
            by = "sa2_code_2021") %>%
  left_join(map_lookup %>% select(sa2_code_2021, dplyr::all_of(extra_cols)),
            by = "sa2_code_2021") %>%
  select(everything(), dplyr::all_of(extra_cols))

```

```{r}
# write.csv(nsw_map_list_to_2021, "nsw_map_list_to_2021.csv",  row.names = FALSE)
# write.csv(nsw_map_list_from_2011, "nsw_map_list_from_2011.csv",  row.names = FALSE)
```

