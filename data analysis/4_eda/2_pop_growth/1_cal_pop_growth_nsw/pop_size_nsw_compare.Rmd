
```{r}
library(dplyr)
library(readr)
library(stringr)
library(tidyr)
```

```{r}
# --- Standardize SA2 keys for joins, but keep original 2021 names as authoritative ---
clean_sa2 <- function(x) {
  x %>%
    str_replace_all("–", "-") %>%
    str_replace_all("[ ]*-[ ]*", " - ") %>%
    str_squish() %>%
    str_to_lower()
}

# --- Read mapping table and add join keys ---
nsw_sa2_mapping <- read_csv("sa2_corres_from_2011.csv") %>%
  mutate(across(where(is.character), str_squish)) %>%
  transmute(
    sa2_name_2011,
    sa2_name_2021,
    weight_2011,
    lga_name_2021,
    nsw_lhd_name,
    key_2011 = clean_sa2(sa2_name_2011),
    key_2021 = clean_sa2(sa2_name_2021)
  )

# 2011 population with join key (2011 names used only for alignment, not authoritative)
pop_nsw_2011 <- read_csv("pop_size_nsw_2011.csv") %>%
  transmute(
    sa2_name_2011 = str_squish(sa2_name_2011),
    key_2011 = clean_sa2(sa2_name_2011),
    pop_2011 = as.numeric(pop_size)
  )

# 2021 population with join key (authoritative SA2 names come from this table)
pop_nsw_2021 <- read_csv("pop_size_nsw_2021.csv") %>%
  transmute(
    sa2_name_2021 = str_squish(sa2_name_2021),   # ← authoritative names
    key_2021 = clean_sa2(sa2_name_2021),
    pop_2021 = as.numeric(pop_size),
    in_wslhd_2021 = as.numeric(in_wslhd),
    in_metro_2021 = as.numeric(in_metro)
  )
```


```{r}
# Check missing mappings
missing_2011 <- anti_join(pop_nsw_2011, nsw_sa2_mapping, by = "key_2011")
missing_2021 <- anti_join(pop_nsw_2021, nsw_sa2_mapping, by = "key_2021")
```


```{r}
# --- Patch non-spatial SA2s: add self-mapped rows with weight = 1 --- 

# Standardised keys for the two special SA2s
k_noaddr <- clean_sa2("No usual address (NSW)")
k_moss   <- clean_sa2("Migratory - Offshore - Shipping (NSW)")

# Helper functions to retrieve authoritative names
name_2021_by_key <- function(k) pop_nsw_2021 %>% filter(key_2021 == k) %>% slice(1) %>% pull(sa2_name_2021)
name_2011_by_key <- function(k) pop_nsw_2011 %>% filter(key_2011 == k) %>% slice(1) %>% pull(sa2_name_2011)

# Create patch rows for missing SA2s
patch_rows <- tibble(
  sa2_name_2011 = c(name_2011_by_key(k_noaddr), name_2011_by_key(k_moss)),
  sa2_name_2021 = c(name_2021_by_key(k_noaddr), name_2021_by_key(k_moss)),
  weight_2011 = 1,
  lga_name_2021 = NA_character_,
  nsw_lhd_name  = NA_character_,
  key_2011 = c(k_noaddr, k_moss),
  key_2021 = c(k_noaddr, k_moss)
)

# Update mapping table with patch rows
nsw_sa2_mapping_fix <- nsw_sa2_mapping %>%
  anti_join(patch_rows %>% select(key_2011, key_2021), by = c("key_2011","key_2021")) %>%
  bind_rows(patch_rows)
```

```{r}
# --- Build pair-level table: 2011 → 2021 with authoritative 2021 names ---
pairs_11to21 <- nsw_sa2_mapping_fix %>%
  left_join(pop_nsw_2011 %>% select(key_2011, pop_2011), by = "key_2011") %>%
  left_join(
    pop_nsw_2021 %>% select(key_2021, sa2_name_2021, pop_2021),
    by = "key_2021",
    suffix = c("_map", "")      # keep authoritative column names from right table
  ) %>%
  mutate(
    pop_2011 = coalesce(pop_2011, 0),
    pop_2021 = coalesce(pop_2021, 0),
    contrib_2011_to_2021 = pop_2011 * weight_2011
  ) %>%
  select(
    sa2_name_2011, pop_2011,
    sa2_name_2021, pop_2021,   # authoritative 2021 names
    weight_2011, contrib_2011_to_2021
  )
```

```{r}
# --- Aggregate 2011 → 2021 equivalent population using authoritative 2021 names ---
pop11_as_21 <- pairs_11to21 %>%
  group_by(sa2_name_2021) %>%
  summarise(pop2011_as21 = sum(contrib_2011_to_2021, na.rm = TRUE), .groups = "drop")
```

```{r}
# --- Combine with 2021 table: final dataset for analysis ---
pop_nsw_11_21 <- pop_nsw_2021 %>%
  left_join(pop11_as_21, by = "sa2_name_2021") %>%
  mutate(
    pop2011_as21 = replace_na(pop2011_as21, 0),
    abs_change   = pop_2021 - pop2011_as21,
    growth_rate  = if_else(pop2011_as21 > 0, abs_change / pop2011_as21, NA_real_)
  )
```


```{r}
# --- Sanity check: raw 2011 total vs. re-aggregated 2011-as-2021 total ---
c(
  total_2011_raw    = sum(pop_nsw_2011$pop_2011, na.rm = TRUE),
  total_2011_as21   = sum(pop11_as_21$pop2011_as21, na.rm = TRUE)
)
```
```{r}
# Drop the join key
pop_nsw_11_21 <- pop_nsw_11_21 %>% 
  select(-key_2021)
```

```{r}
# write.csv(pop_nsw_11_21, "pop_size_nsw_compare.csv", row.names = FALSE)
```
